<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RikiApp Admin</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --bg: #f1f5f9; }
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        #login-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; padding: 20px; 
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding:30px; border-radius:20px; width:100%; max-width: 350px; text-align:center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: white;
        }
        .login-input { 
            width:100%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; 
            background: rgba(0,0,0,0.2); color: white; outline: none; 
        }
        
        aside { width:260px; background:var(--primary); color:white; display:flex; flex-direction:column; flex-shrink: 0; transition: 0.3s; }
        .brand { padding:20px; font-size:20px; font-weight:bold; border-bottom:1px solid #334155; display: flex; align-items: center; }
        .menu-item { padding:16px 20px; cursor:pointer; color:#cbd5e0; display:flex; align-items:center; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background:#334155; color:white; border-left: 4px solid var(--accent); }
        
        main { flex:1; padding:30px; overflow-y:auto; position: relative; }
        .card { background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .upload-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 500; }
        .form-input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; background: white; }
        .full-width { grid-column: span 2; }
        .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width:100%; border-collapse:collapse; white-space: nowrap; }
        th, td { padding:14px; text-align:left; border-bottom:1px solid #eee; }
        .btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; color:white; font-size:13px; font-weight: 500; transition: 0.2s; }
        .btn-green { background:#10b981; } .btn-blue { background:#3b82f6; } .btn-red { background:#ef4444; }
        .multi-preview { display: flex; gap: 8px; overflow-x: auto; margin-top: 5px; }
        .multi-preview img { height: 60px; border-radius: 4px; border: 1px solid #eee; }
        .kyc-details { font-size: 13px; color: #444; line-height: 1.6; }
        
        @media (max-width: 768px) { body { flex-direction: column; height: 100vh; } aside { width: 100%; height: auto; flex-direction: row; overflow-x: auto; align-items: center; padding: 0 10px; } .brand span { display: none; } main { padding: 15px; padding-bottom: 80px; } .upload-form { grid-template-columns: 1fr; gap: 10px; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h3>RikiApp Admin</h3>
        <input type="email" id="adm-email" class="login-input" placeholder="admin@email.com">
        <input type="password" id="adm-pass" class="login-input" placeholder="Password">
        <button class="btn btn-green" style="width:100%; padding:12px; margin-top:10px;" onclick="doLogin()">Login</button>
        <p id="login-msg" style="color:#ff6b6b; font-size:13px; margin-top:10px;"></p>
    </div>
</div>

<aside>
    <div class="brand"><span class="material-icons-round" style="margin-right:8px; color:#34d399">admin_panel_settings</span>Admin</div>
    <div class="menu-item active" onclick="tab('pay')">Approvals</div>
    <div class="menu-item" onclick="tab('kyc')">KYC Verify</div>
    <div class="menu-item" onclick="tab('wd')">Withdrawals</div>
    <div class="menu-item" onclick="tab('apps')">App Manager</div>
    <div class="menu-item" onclick="firebase.auth().signOut()">Logout</div>
</aside>

<main>
    <div id="tab-pay">
        <h2>Payment Requests (₹299)</h2>
        <div class="card"><div class="table-responsive"><table><thead><tr><th>UID</th><th>UTR</th><th>Proof</th><th>Action</th></tr></thead><tbody id="tbl-pay"></tbody></table></div></div>
    </div>
    <div id="tab-kyc" style="display:none">
        <h2>KYC Verification Requests</h2>
        <div class="card"><div class="table-responsive"><table><thead><tr><th>Developer</th><th>Documents</th><th>Type</th><th>Action</th></tr></thead><tbody id="tbl-kyc"></tbody></table></div></div>
    </div>
    <div id="tab-wd" style="display:none">
        <h2>Withdrawal Requests</h2>
        <div class="card"><div class="table-responsive"><table><thead><tr><th>UID</th><th>Amount</th><th>Method</th><th>Details</th><th>Status</th><th>Action</th></tr></thead><tbody id="tbl-wd"></tbody></table></div></div>
    </div>
    <div id="tab-apps" style="display:none">
        <div class="card" style="border-top: 4px solid var(--accent);">
            <h3 style="margin-top:0; color:var(--accent)">Upload App / Link</h3>
            <div class="upload-form">
                <div class="form-group"><label>App Name</label><input type="text" id="up-name" class="form-input"></div>
                <div class="form-group"><label>Type</label><select id="up-type" onchange="updateAdminCategories()"><option value="App">App</option><option value="Game">Game</option></select></div>
                <div class="form-group"><label>Category</label><select id="up-cat"></select></div>
                <div class="form-group"><label>Version</label><input type="text" id="up-ver" class="form-input"></div>
                <div class="form-group full-width"><label>Download Link</label><input type="url" id="up-url" class="form-input"></div>
                <div class="form-group full-width"><label>Privacy Policy</label><input type="url" id="up-policy" class="form-input"></div>
                <div class="form-group full-width"><label>Description</label><input type="text" id="up-desc" class="form-input"></div>
                <div class="form-group"><label>Icon</label><input type="file" id="up-icon" class="form-input" accept="image/*"></div>
                <div class="form-group"><label>Screenshots (Min 2)</label><input type="file" id="up-screens" class="form-input" multiple accept="image/*" onchange="previewAdminImgs(this)"><div id="admin-preview" class="multi-preview"></div></div>
            </div>
            <button class="btn btn-blue" style="margin-top:20px;" onclick="adminUpload()">Publish App</button>
            <span id="up-status" style="margin-left:15px; font-size:14px; font-weight:500;"></span>
        </div>
        <h2>Published Apps</h2>
        <div class="card"><div class="table-responsive"><table><thead><tr><th>Icon</th><th>Name</th><th>Type</th><th>DLs</th><th>Status</th><th>Action</th></tr></thead><tbody id="tbl-apps"></tbody></table></div></div>
    </div>
</main>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBpK2TQhhdtm9eEGN8TEE6WTW3natf47OA",
        authDomain: "rikiapp-c3b21.firebaseapp.com",
        databaseURL: "https://rikiapp-c3b21-default-rtdb.firebaseio.com",
        projectId: "rikiapp-c3b21",
        storageBucket: "rikiapp-c3b21.firebasestorage.app",
        messagingSenderId: "947081687732",
        appId: "1:947081687732:web:3808455f70e06e95869de1"
    };
    const IMGBB_KEY = "07806a9e0f6db8a56403fcc0c909b163";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const categories = { "App": ["Art & Design", "Business", "Education", "Entertainment", "Finance", "Health", "Lifestyle", "Music", "Photography", "Productivity", "Social", "Tools", "Video Players", "Weather"], "Game": ["Action", "Adventure", "Arcade", "Board", "Card", "Puzzle", "Racing", "RPG", "Simulation", "Sports", "Strategy"] };

    // ADMIN CHECK LOGIC
    auth.onAuthStateChanged(user => {
        if(user) { 
            db.ref('users/' + user.uid).once('value').then(snapshot => {
                const userData = snapshot.val();
                if(userData && userData.role === 'admin') {
                    document.getElementById('login-overlay').style.display = 'none';
                    updateAdminCategories();
                } else {
                    document.getElementById('login-msg').innerText = "Access Denied: You are not an Admin!";
                    auth.signOut();
                }
            });
        } else { 
            document.getElementById('login-overlay').style.display = 'flex'; 
        }
    });

    function doLogin() { 
        document.getElementById('login-msg').innerText = "Checking...";
        auth.signInWithEmailAndPassword(document.getElementById('adm-email').value, document.getElementById('adm-pass').value).catch(err => {
            document.getElementById('login-msg').innerText = err.message;
        }); 
    }

    function tab(name) { document.querySelectorAll('[id^="tab-"]').forEach(el => el.style.display = 'none'); document.getElementById('tab-'+name).style.display = 'block'; }
    window.updateAdminCategories = () => { const type = document.getElementById('up-type').value; const catSelect = document.getElementById('up-cat'); catSelect.innerHTML = ""; categories[type].forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; catSelect.appendChild(opt); }); }

    db.ref('paymentRequests').on('value', snap => { const t = document.getElementById('tbl-pay'); t.innerHTML = ''; snap.forEach(c => { const d = c.val(); if(d.status === 'pending') t.innerHTML += `<tr><td>${d.uid}</td><td>${d.txnId}</td><td><a href="${d.screenshot}" target="_blank">View</a></td><td><button class="btn btn-green" onclick="approvePayment('${c.key}','${d.uid}')">Approve Payment</button></td></tr>`; }); });
    function approvePayment(key, uid) { db.ref('paymentRequests/'+key).update({status:'approved'}); db.ref('developers/'+uid).update({paymentStatus:'approved'}); }

    db.ref('kycData').on('value', snap => { const t = document.getElementById('tbl-kyc'); t.innerHTML = ''; snap.forEach(c => { const d = c.val(); db.ref('developers/'+c.key).once('value', devSnap => { const dev = devSnap.val(); if(dev && dev.kycStatus === 'pending') { t.innerHTML += `<tr><td><b>${d.legalName}</b><br>${d.email}</td><td><div class="kyc-details">Aadhar: ${d.aadhar}<br>PAN: ${d.pan}<br>Mobile: ${d.mobile}<br>Addr: ${d.address}<br>Web: ${d.website||'N/A'}</div></td><td>${d.accType}</td><td><button class="btn btn-green" onclick="approveKYC('${c.key}')">Unlock Account</button></td></tr>`; } }); }); });
    function approveKYC(uid) { if(!confirm("Documents Verified? Unlock Account?")) return; db.ref('developers/'+uid).update({kycStatus:'approved', lifetimePaid:true}); }

    db.ref('withdrawals').on('value', snap => { const t = document.getElementById('tbl-wd'); t.innerHTML = ''; snap.forEach(c => { const d = c.val(); if(d.status === 'pending') { t.innerHTML += `<tr><td>${d.uid.substr(0,8)}</td><td><b>₹${d.amount}</b></td><td>${d.method}</td><td><div class="wd-details">${d.details}</div></td><td style="color:orange">${d.status}</td><td><button class="btn btn-green" onclick="approveWD('${c.key}','${d.uid}', ${d.amount})">Pay</button></td></tr>`; } }); });
    function approveWD(key, uid, amount) { if(!confirm(`Confirm payment of ₹${amount}?`)) return; db.ref('withdrawals/'+key).update({status:'approved'}); db.ref('developers/'+uid+'/paidOut').transaction(current => (current || 0) + amount); }

    db.ref('apps').on('value', snap => { const t = document.getElementById('tbl-apps'); t.innerHTML = ''; snap.forEach(c => { const a = c.val(); t.innerHTML += `<tr><td><img src="${a.icon}" width="32"></td><td>${a.name}</td><td>${a.type}</td><td>${a.downloads||0}</td><td>${a.status}</td><td>${a.status!=='published' ? `<button class="btn btn-green" onclick="setSt('${c.key}','published')">✓</button>` : ''}<button class="btn btn-red" onclick="setSt('${c.key}','rejected')">✕</button></td></tr>`; }); });
    function setSt(k, s) { db.ref('apps/'+k).update({status:s}); }

    window.previewAdminImgs = (input) => { const c = document.getElementById('admin-preview'); c.innerHTML=''; for(let i=0; i<Math.min(input.files.length, 8); i++){ const r = new FileReader(); r.onload = e => { const img=document.createElement('img'); img.src=e.target.result; c.appendChild(img); }; r.readAsDataURL(input.files[i]); } }

    async function adminUpload() {
        const status = document.getElementById('up-status'); const btn = document.querySelector('.btn-blue');
        const name = document.getElementById('up-name').value; const url = document.getElementById('up-url').value; const policy = document.getElementById('up-policy').value;
        const iconFile = document.getElementById('up-icon').files[0]; const screenFiles = document.getElementById('up-screens').files;
        const type = document.getElementById('up-type').value; const cat = document.getElementById('up-cat').value;

        if(!name || !url || !iconFile) return alert("Fill required fields"); if(screenFiles.length < 2) return alert("Min 2 screenshots");
        btn.disabled = true; status.innerText = "Uploading..."; status.style.color = "orange";

        try {
            const upImg = async (f) => { const fd = new FormData(); fd.append("image", f); const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:'POST', body:fd}); const j=await r.json(); return j.data.url; };
            const iUrl = await upImg(iconFile);
            const uploadPromises = Array.from(screenFiles).map(file => upImg(file));
            const sUrls = await Promise.all(uploadPromises);

            status.innerText = "Publishing...";
            await db.ref('apps').push({
                name: name, type: type, category: cat, privacyPolicy: policy,
                version: document.getElementById('up-ver').value || '1.0', description: document.getElementById('up-desc').value || '',
                downloadUrl: url, icon: iUrl, screenshots: sUrls,
                ownerUid: 'ADMIN', devName: 'RikiApp Official', devEmail: 'admin@rikiapp.com', devWebsite: 'https://rikiapp.com',
                status: 'published', timestamp: Date.now(), downloads: 0
            });
            status.innerText = "Success!"; status.style.color = "green";
            document.querySelectorAll('.upload-form input').forEach(i => i.value = ''); document.getElementById('admin-preview').innerHTML = '';
        } catch(e) { status.innerText = "Error: " + e.message; status.style.color = "red"; }
        btn.disabled = false;
    }
</script>
</body>
</html>